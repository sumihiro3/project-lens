# Requirements Document

## 概要

ProjectLens は、Backlog MCP Server を活用したデスクトップアプリケーションです。複数のBacklogスペースから関連度の高いチケットを自動抽出・表示・通知し、LLMを活用した優先チケットの要約・対応アドバイス機能を提供します。バックグラウンド常駐により継続的な監視を行い、ユーザーの効率的なタスク管理をサポートします。

## 要件

### 要件1: Backlog連携・データ管理システム

**ユーザーストーリー:** 開発者として、複数のBacklogスペースのプロジェクトから必要なデータを自動取得・管理したい。そうすることで、複数スペースのチケット状況を一元的に把握できる。

#### 受入基準

1. **WHEN** アプリケーションが初回起動される **THEN** システムは段階的優先度取得戦略を実行する **SHALL**
   - Stage 1: 高優先度データ（自分担当・期限迫るチケット）を5-10リクエストで即座取得し表示
   - Stage 2: 中優先度データ（直近3か月全課題）をバックグラウンド取得
   - Stage 3: 履歴データ（1か月分）をアイドル時取得

2. **WHEN** ユーザーがBacklogスペース設定を追加する **THEN** システムは当該スペース用のMCP接続を確立する **SHALL**

3. **IF** APIレート制限（150 req/分 × スペース数）に到達する **THEN** システムは並列処理を調整し効率化する **SHALL**

4. **WHILE** アプリケーションが動作中 **THE SYSTEM SHALL** SQLiteデータベースに最低1か月分のデータを保持する

5. **WHEN** データ取得時にエラーが発生する **THEN** システムはPinoログライブラリでエラーレベル別に記録する **SHALL**

6. **WHEN** 前回取得時刻以降の差分更新が必要な場合 **THEN** システムは`updatedSince`パラメーターを活用して効率的に取得する **SHALL**

### 要件2: チケット関連度スコアリングシステム

**ユーザーストーリー:** 開発者として、自分に関連度の高いチケットを優先順位付きで把握したい。そうすることで、緊急対応が必要なチケットを見落とすことなく、効率的にタスクを処理できる。

#### 受入基準

1. **WHEN** チケットの担当者が自分であり期限が過ぎている **OR** 迫っている（1週間以内） **THEN** システムは優先度1（Critical）に分類する **SHALL**

2. **WHEN** チケットの担当者が自分であり最近更新された（3日以内） **THEN** システムは優先度1（Critical）に分類する **SHALL**

3. **IF** チケットに自分が多くコメントしている **AND** 直近3か月間での活動がある **THEN** システムは優先度2（Important）に分類する **SHALL**

4. **WHEN** チケットに自分へのメンションが多い **THEN** システムは優先度2（Important）に分類する **SHALL**

5. **IF** チケットの通知先（Watch）に自分が設定されている **THEN** システムは優先度2（Important）に分類する **SHALL**

6. **WHEN** スコアリング設定が変更される **THEN** システムは設定値（期限警告日数、コメント判定最小件数、重み付け比率）を適用してスコアを再計算する **SHALL**

### 要件3: 通知システム

**ユーザーストーリー:** 開発者として、重要なチケットの更新を適切なタイミングで通知を受けたい。そうすることで、緊急対応が必要な場合は即座に、中優先度の場合は集約された形で確認できる。

#### 受入基準

1. **WHEN** 高優先度（Critical）チケットが検知される **THEN** システムは即座通知を発行する **SHALL**

2. **WHEN** 中優先度（Important）チケットが検知される **THEN** システムは5分後に集約通知を発行する **SHALL**

3. **IF** システム通知設定が有効 **AND** macOS **OR** Windows環境 **THEN** システムはnode-notifierライブラリでクロスプラットフォーム通知を表示する **SHALL**

4. **WHEN** 通知がクリックされる **THEN** システムはアプリケーションを起動・表示する **SHALL**

5. **WHILE** 通知機能が動作中 **THE SYSTEM SHALL** 重複通知防止機能を適用する

6. **IF** 通知設定でOFF設定 **THEN** システムは通知を発行しない **SHALL**

7. **WHEN** バッチ処理頻度が設定で調整される **THEN** システムは指定間隔（デフォルト1時間）で定期更新を実行する **SHALL**

### 要件4: LLM機能・AI要約アドバイス

**ユーザーストーリー:** 開発者として、優先チケット群の要約と個別チケットの対応アドバイスをAIから受けたい。そうすることで、効率的な作業順序の判断と具体的な対応方針を決定できる。

#### 受入基準

1. **WHEN** 関連度の高いチケット群が特定される **THEN** システムはMastraフレームワーク経由でLLM要約を生成する **SHALL**
   - 日次サマリー: チケット群の概要を自然言語で生成
   - 緊急度の説明: 優先順位の理由を明確化
   - 作業順序の提案: 効率的なタスク処理順序をアドバイス

2. **WHEN** 個別チケット詳細が表示される **THEN** システムは対応アドバイスを生成する **SHALL**
   - 過去事例の参照: 類似チケットの解決方法を提案
   - 担当者の推奨: 関連知識を持つチームメンバーの提案
   - 次のアクション: 具体的な対応手順の提案

3. **IF** LLMプロバイダー設定でClaude **OR** GPT-4 **OR** Geminiが選択 **THEN** システムは選択されたプロバイダーのAPIを使用する **SHALL**

4. **WHEN** LLM機能の有効/無効設定が変更される **THEN** システムは要約・アドバイス機能の動作を制御する **SHALL**

5. **WHILE** LLM処理実行中 **THE SYSTEM SHALL** プライバシーレベル設定に従い必要最小限の情報のみを送信する

6. **IF** LLM API通信エラーが発生 **THEN** システムはローカル処理優先に切り替えエラーを記録する **SHALL**

### 要件5: ユーザーインターフェイス

**ユーザーストーリー:** 開発者として、直感的で使いやすいデスクトップUIでチケット情報とAI要約を確認したい。そうすることで、素早い情報把握と効率的な操作を実現できる。

#### 受入基準

1. **WHEN** アプリケーションが起動される **THEN** システムはElectron + Nuxt 3 + Vuetifyで構成されたメイン画面を表示する **SHALL**
   - 関連度順チケットリスト
   - AI要約表示領域
   - フィルター・ソート機能

2. **WHEN** ユーザーがチケットを選択する **THEN** システムは詳細画面を表示する **SHALL**
   - 個別チケットの詳細情報
   - AI対応アドバイス
   - 関連コメント・履歴

3. **WHEN** 設定変更が必要 **THEN** システムは設定画面を提供する **SHALL**
   - Backlog接続設定（複数スペース対応）
   - LLM各種設定
   - 通知・スコアリング設定

4. **WHEN** アプリケーションログの確認が必要 **THEN** システムはログ表示画面を提供する **SHALL**

5. **IF** アプリケーションが最小化される **THEN** システムはシステムトレイに格納する **SHALL**

6. **WHEN** システムトレイアイコンが右クリックされる **THEN** システムはクイックアクションメニューを表示する **SHALL**

### 要件6: 設定管理システム

**ユーザーストーリー:** 開発者として、複数のBacklogスペースとLLM設定を柔軟に管理したい。そうすることで、個人の作業環境に最適化された設定でツールを使用できる。

#### 受入基準

1. **WHEN** 初回設定が行われる **THEN** システムは`~/.config/project-lens/`ディレクトリに設定ファイルを作成する **SHALL**
   - `database.sqlite3`: データベースファイル
   - `config.json`: 設定ファイル
   - `logs/`: ログディレクトリ

2. **WHEN** Backlog接続設定が追加される **THEN** システムはスペース毎に以下を暗号化して保存する **SHALL**
   - ドメイン（example.backlog.com）
   - APIキー
   - 表示名（ユーザー識別用）

3. **WHEN** LLM設定が変更される **THEN** システムは以下項目を保存する **SHALL**
   - プロバイダー選択（Claude/OpenAI/Gemini）
   - 対応するAPIキー
   - 機能の有効/無効設定
   - プライバシーレベル設定

4. **IF** スコアリング設定が調整される **THEN** システムは設定値を保存し即座に適用する **SHALL**
   - 期限警告日数（デフォルト: 7日）
   - コメント・メンション集計期間（デフォルト: 1か月）
   - 各要素の重み付け比率

5. **WHEN** 対象プロジェクト設定が変更される **THEN** システは各スペース内で監視するプロジェクトリストを更新する **SHALL**

### 要件7: バックグラウンド処理・システム常駐

**ユーザーストーリー:** 開発者として、アプリケーションを常駐させて継続的にチケット監視を行いたい。そうすることで、手動チェックなしで重要な更新を見逃さない。

#### 受入基準

1. **WHEN** アプリケーションが開始される **THEN** システムはnode-cronライブラリでバッチ処理スケジューリングを設定する **SHALL**

2. **WHILE** バックグラウンド処理が動作中 **THE SYSTEM SHALL** 設定された頻度（デフォルト1時間）で定期更新を実行する

3. **WHEN** 定期更新処理が実行される **THEN** システムは差分検知により変更があった場合のみ通知する **SHALL**

4. **IF** システムトレイ常駐中 **AND** 新しい更新が検知される **THEN** システムはトレイアイコンに更新件数を表示する **SHALL**

5. **WHEN** ネットワークエラーが発生する **THEN** システムはリトライ機構を実行し失敗をログに記録する **SHALL**

6. **WHILE** 古いデータクリーンアップ処理実行中 **THE SYSTEM SHALL** 1か月を超えるデータを自動削除する

7. **IF** アプリケーション終了時 **THEN** システムは処理中のバックグラウンドタスクを適切に終了する **SHALL**
