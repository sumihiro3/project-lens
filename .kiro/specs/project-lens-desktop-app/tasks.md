# 実装計画

## 概要

ProjectLensデスクトップアプリケーションの段階的実装計画です。テスト駆動開発アプローチを採用し、各タスクは実装可能なコード生成プロンプトとして設計されています。

## 実装タスク

### フェーズ1: プロジェクト基盤とインフラストラクチャ

- [x] 1.1 基本プロジェクト構造の構築
  - Electron + Nuxt 3の基本ディレクトリ構造を作成する
  - electron-viteによるビルド設定を構築する
  - 基本的なパッケージ依存関係を設定する
  - _要件: 1.1, 6.1_
  - _依存関係: なし_

- [x] 1.2 TypeScript設定と型基盤の構築
  - TypeScript strict mode設定を追加する
  - 共通型定義（Backlog、AI、Settings関連）を作成する
  - ESLint + Prettier設定を追加する
  - _要件: 1.1, 6.1_
  - _依存関係: 1.1_

- [x] 1.3 Pugテンプレートエンジン統合
  - @nuxtjs/pugモジュールをNuxt 3に統合する
  - Pugコンパイルとホットリロード設定を追加する
  - VuetifyコンポーネントとPugの組み合わせパターンを確立する
  - 基本レイアウトテンプレートをPug形式で作成する
  - _要件: 5.2, 8.1_
  - _依存関係: 1.1, 1.2_

- [x] 1.4 開発環境とビルドコマンド設定
  - 開発用スクリプト（dev, build, test, lint）を設定する
  - electron-viteによる開発サーバー設定を追加する
  - クロスプラットフォームビルド設定を構築する
  - _要件: 6.1_
  - _依存関係: 1.1, 1.2, 1.3_

- [x] 1.5 データベース基盤とスキーマの実装
  - Drizzle ORMを使用したSQLiteデータベース接続を設定する
  - 主要テーブル（spaces, issues, comments, settings等）のスキーマを定義する
  - データベースマイグレーション機能を実装する
  - 接続管理とエラーハンドリングを追加する
  - _要件: 1.4, 6.1, 6.2_
  - _依存関係: 1.2_

- [ ] 1.6 ログシステムとエラーハンドリング基盤の構築
  - Pinoログライブラリを統合しレベル別ログ出力を設定する
  - 構造化ログとファイル出力を実装する
  - 統一エラーハンドリングクラスを作成する
  - 開発・本番環境別のログ設定を追加する
  - _要件: 1.5_
  - _依存関係: 1.2_

### フェーズ2: Backlog連携とデータ取得

- [ ] 2.1 Backlog Direct API接続管理サービスの実装（プライマリ）
  - Backlog REST API接続クライアントを作成する
  - レート制限ヘッダー（X-RateLimit-*）の監視機能を実装する
  - 複数Backlogスペースの並列接続とレート制限調整を実装する
  - APIキー認証とエラーハンドリングを追加する
  - _要件: 1.2, 1.3_
  - _技術的根拠: レート制限情報の完全取得によりAPIレート制限対応機能を適切に実装_

- [ ] 2.2 段階的データ取得戦略の実装（レート制限対応）
  - Stage 1: 高優先度データの即座取得機能を実装する（5-10リクエスト）
  - Stage 2: 中優先度データのバックグラウンド取得を実装する（レート制限残量監視）
  - Stage 3: 履歴データのアイドル時取得機能を追加する（スロットリング制御）
  - 差分更新用のupdatedSinceパラメーター活用機能を実装する
  - レート制限ヘッダーによる動的並列処理数調整を追加する
  - _要件: 1.1, 1.6_

- [ ] 2.3 SQLiteキャッシュベース冗長性の実装
  - エラーハンドラーによるAPIエラー検出とキャッシュモード切替を実装する
  - SQLiteキャッシュマネージャーによるオフラインデータ管理を作成する
  - 自動データ同期と復旧機能を追加する
  - ステータスUIでの接続状態通知を実装する
  - _要件: 1.2, 1.3, 1.5_
  - _依存関係: 2.1, 2.2_
  - _技術的根拠: シンプルなSQLキャッシュベース冗長性で高い信頼性を実現_

### フェーズ3: スコアリングエンジンと優先度システム

- [ ] 3.1 基本スコアリングアルゴリズムの実装
  - チケット関連度計算ロジックを実装する
  - 担当者・期限・更新日による優先度1（Critical）判定機能を作成する
  - コメント数・メンション・Watch設定による優先度2（Important）判定を実装する
  - スコア計算結果のデータベース保存機能を追加する
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 3.2 コメント分析とメンション検出機能
  - チケットコメントの解析機能を実装する
  - 自分へのメンション検出ロジックを作成する
  - コメント活動頻度の分析機能を追加する
  - Watch状態の判定とスコアリング統合を実装する
  - _要件: 2.3, 2.4, 2.5_

- [ ] 3.3 カスタマイズ可能なスコアリング設定
  - 期限警告日数、コメント判定件数、重み付け比率の設定機能を実装する
  - 設定変更時の自動スコア再計算機能を追加する
  - ユーザー定義ルールによるスコアリング調整を実装する
  - 設定値の永続化とバリデーション機能を作成する
  - _要件: 2.6_

### フェーズ4: 通知システムと定期処理

- [ ] 4.1 通知サービスとクロスプラットフォーム対応
  - node-notifierを使用したシステム通知機能を実装する
  - 高優先度チケットの即座通知機能を作成する
  - 中優先度チケットの5分後集約通知を実装する
  - 通知クリック時のアプリ起動・表示機能を追加する
  - _要件: 3.1, 3.2, 3.4_

- [ ] 4.2 バックグラウンドワーカーと定期処理
  - node-cronを使用した定期更新スケジューラーを実装する
  - バッチ処理頻度の設定機能を作成する
  - 重複通知防止とシステムトレイ更新件数表示を実装する
  - 古いデータのクリーンアップ機能を追加する
  - _要件: 3.5, 3.7, 7.1, 7.2, 7.6_

- [ ] 4.3 通知設定管理と制御機能
  - 通知の有効/無効設定機能を実装する
  - 通知履歴の記録と管理機能を作成する
  - システム常駐時の通知制御を実装する
  - ネットワークエラー時のリトライ機構を追加する
  - _要件: 3.3, 3.6, 7.5_

### フェーズ5: Mastra AI統合と要約機能

- [ ] 5.1 MastraフレームワークとLLM統合基盤
  - @mastra/coreを使用したAIサービス基盤を実装する
  - Claude、GPT-4、Gemini対応のプロバイダー切り替え機能を作成する
  - プライバシーレベル設定による最小限データ送信機能を実装する
  - LLMプロバイダーのAPI接続テスト機能を追加する
  - _要件: 4.3, 4.4, 4.5_

- [ ] 5.2 優先チケット群の要約生成機能
  - 関連度の高いチケット群からの日次サマリー生成を実装する
  - 緊急度の説明と優先順位の理由明確化機能を作成する
  - 効率的なタスク処理順序の提案機能を実装する
  - 生成された要約のキャッシュとデータベース保存を追加する
  - _要件: 4.1_

- [ ] 5.3 個別チケット対応アドバイス機能
  - 過去事例参照による解決方法提案機能を実装する
  - 関連知識を持つチームメンバーの推奨機能を作成する
  - 具体的な対応手順提案の生成機能を実装する
  - アドバイス生成結果のキャッシュとユーザー評価機能を追加する
  - _要件: 4.2_

- [ ] 5.4 MastraフォールバックManagerの実装
  - MastraFallbackManagerによる障害検出・プロバイダー切り替えを実装する
  - プロバイダー健全性チェックとテスト機能を作成する
  - 代替プロバイダーへの自動切り替え機能を追加する
  - _要件: 4.6_
  - _依存関係: 5.1, 5.2, 5.3_

- [ ] 5.5 ローカルAIプロセッサーの実装
  - LocalAIProcessorによるオフライン処理機能を実装する
  - ルールベース要約生成機能を作成する
  - テンプレートベースアドバイス機能を実装する
  - AI機能無効時の代替表示とエラー処理を追加する
  - _要件: 4.6_
  - _依存関係: 5.4_

### フェーズ6: Electron UIとメイン画面

- [ ] 6.1 Electronメインプロセスの実装
  - Electronアプリケーションのメインプロセスを作成する
  - ウィンドウ管理とシステムトレイ統合を実装する
  - アプリケーション起動時の初期化処理を追加する
  - グレースフルシャットダウンと終了処理を実装する
  - _要件: 5.1, 5.5, 5.6_

- [ ] 6.2 Nuxt 3アプリケーションとルーティング
  - Nuxt 3によるレンダラープロセスアプリケーションを作成する
  - ページルーティング（メイン、設定、ログ、チケット詳細）を実装する
  - レイアウトコンポーネント（デフォルト、ミニマル）を作成する
  - Electron統合プラグインを実装する
  - _要件: 5.1, 5.2_

- [ ] 6.3 設定管理UIとデータ永続化
  - 設定画面での複数Backlogスペース管理UIを実装する
  - LLM設定（プロバイダー、APIキー、機能有効/無効）の管理画面を作成する
  - スコアリング設定の調整UIを実装する
  - 設定の暗号化保存と ~/.config/project-lens/ への永続化を追加する
  - _要件: 5.3, 6.2, 6.3, 6.4, 6.5_

- [ ] 6.4 システム統合機能の実装
  - システムトレイ詳細実装（右クリックメニュー）を作成する
  - アプリケーション自動起動設定を実装する
  - ウィンドウ状態の永続化（位置・サイズ）を追加する
  - システムトレイアイコンの状態表示（通知件数）を実装する
  - _要件: 5.5, 5.6, 7.1_
  - _依存関係: 6.1, 6.2_

### フェーズ7: Vue I18n多言語化とPugテンプレート統合

- [ ] 7.1 Vue I18n国際化基盤の実装
  - @nuxtjs/i18nとVue I18nによる国際化基盤を実装する
  - 日本語・英語の翻訳リソースファイルを作成する
  - システム言語の自動検出と設定永続化機能を実装する
  - _要件: 8.1, 8.2, 8.3, 8.4_
  - _依存関係: 6.2, 1.3_

- [ ] 7.2 PugテンプレートとVuetifyの統合パターン確立
  - VuetifyコンポーネントのPugテンプレート記法パターンを確立する
  - コンポーネントpropsとイベントハンドリングのPug記法を標準化する
  - 条件分岐とループ処理のベストプラクティスを確立する
  - Vue I18nとPugの組み合わせパターンを実装する
  - _要件: 5.2, 8.1_
  - _依存関係: 7.1, 1.3_

- [ ] 7.3 チケット表示コンポーネントの実装（Pug + Vuetify）
  - IssueCardコンポーネントをPug + Vuetifyで実装する
  - IssueListコンポーネントのフィルター・ソート機能を作成する
  - IssueDetailコンポーネントによる詳細表示とAIアドバイス統合を実装する
  - 関連度順リスト表示とリアルタイム更新機能を追加する
  - _要件: 5.1, 5.2_
  - _依存関係: 7.2_

- [ ] 7.4 共通UIコンポーネントの作成（Pug + Vuetify）
  - LanguageSelectorによる言語切り替えUIをPugで実装する
  - NotificationToastによるシステム通知UIを作成する
  - StatusIndicatorによる接続状態・サービス状態表示を実装する
  - システムトレイ用クイックアクションメニューを追加する
  - _要件: 5.6, 8.1, 8.2_
  - _依存関係: 7.2, 7.1_

- [ ] 7.5 既存HTMLテンプレートのPug変換
  - 基本レイアウトテンプレートをPug形式に変換する
  - 設定画面・ログ画面等の既存HTMLをPug化する
  - 変換後のテンプレートの動作確認とHMRテストを実行する
  - _要件: 5.2_
  - _依存関係: 7.2, 6.2, 6.3_

### フェーズ8: データストアとリアクティブ状態管理

- [ ] 8.1 Piniaストアによる状態管理の実装
  - Backlogデータストアによるチケット状態管理を実装する
  - AI要約・アドバイスストアによるキャッシュと状態管理を作成する
  - 設定ストアによるアプリ設定の管理を実装する
  - 通知ストアによる通知状態と履歴管理を追加する
  - _要件: 1.1, 4.1, 4.2, 6.2_

- [ ] 8.2 Composable関数による機能統合
  - useBacklogDataによるBacklogデータ操作機能を実装する
  - useAIによるMastra AI機能の統合を作成する
  - useSettingsによる設定管理機能を実装する
  - useNotificationによる通知機能の統合を追加する
  - _要件: 1.1, 4.1, 4.2, 6.2_

### フェーズ9: 統合テストと品質保証

- [ ] 9.1 ユニットテストの実装
  - BacklogAPIManager、ScoringEngine、NotificationServiceのテストを作成する
  - データベース操作とマイグレーションのテストを実装する
  - AI機能とフォールバック機能のテストを追加する
  - 設定管理と暗号化機能のテストを作成する
  - _テストカバレッジ: ≥80%_

- [ ] 9.2 統合テストと E2E テストの実装
  - アプリケーション起動からデータ取得までの統合テストを作成する
  - Direct API接続、スコアリング、通知の E2E テストを実装する
  - UI操作とユーザージャーニーの自動化テストを追加する
  - パフォーマンステスト（起動時間<3秒、メモリ<500MB）を実装する
  - _性能目標の検証とフォールバック動作確認_

- [ ] 9.3 最終統合とリリース準備
  - 全機能の統合と動作検証を実行する
  - クロスプラットフォームビルド（macOS/Windows）を実装する
  - アプリケーションパッケージングとインストーラー作成を行う
  - プロダクション設定とセキュリティ検証を完了する
  - _リリース可能な完全統合アプリケーション_

## タスク完了基準

各タスクは以下の基準で完了と判定されます：

- コードの実装が完了し、エラーなく動作する
- 関連するユニットテストがすべて通過する
- 該当する要件の受入基準を満たしている
- TypeScript型エラーがない
- ESLintエラーがない
- パフォーマンス要件を満たしている

## 実装順序の依存関係

### フェーズ間依存関係

- **フェーズ1→2**: データベース基盤とTypeScript型定義が必要
- **フェーズ2→3**: Backlogデータ取得とレジリエンス監視基盤が必要
- **フェーズ3→4**: スコアリング結果が必要
- **フェーズ4→5**: 通知システムが必要
- **フェーズ5→6**: AI機能とフォールバック機能が必要
- **フェーズ6→7**: Electron基盤が必要
- **フェーズ7→8**: UIコンポーネントとPugテンプレート統合が必要
- **すべて→9**: 全機能統合が必要

### タスク内依存関係（重要）

#### フェーズ1内の依存関係

```txt
1.1 → 1.2 → 1.3 → 1.4
     ↘      ↗
      1.5, 1.6
```

#### フェーズ2内の依存関係

```txt
2.1, 2.2 → 2.3 → 2.4
```

#### フェーズ5内の依存関係

```txt
5.1 → 5.2, 5.3 → 5.4 → 5.5
```

#### フェーズ7内の依存関係

```txt
7.1 → 7.2 → 7.3, 7.4
          ↘ 7.5
```

### レジリエンス機能の実装順序

1. **監視基盤** (2.3): サービス健全性チェック
2. **キャッシュフォールバック** (2.3): API障害時の代替手段
3. **Mastraフォールバック** (5.4): AI機能障害時の代替手段
4. **ローカルAI** (5.5): 完全オフライン対応

### Pugテンプレート統合の実装順序

1. **基本統合** (1.3): @nuxtjs/pugモジュール統合とHMR設定
2. **パターン確立** (7.2): VuetifyとPugの組み合わせパターン
3. **コンポーネント実装** (7.3, 7.4): 新規コンポーネントのPug実装
4. **既存変換** (7.5): HTMLテンプレートのPug変換

### 推奨実装順序

#### コア機能優先アプローチ

1. フェーズ1 (1.1 → 1.2 → 1.3 → 1.5 → 1.6 → 1.4)
2. フェーズ2 (2.1 → 2.2)
3. フェーズ3 (3.1 → 3.2 → 3.3)
4. フェーズ6 (6.1 → 6.2 → 6.3 → 6.4)
5. フェーズ7 (7.1 → 7.2 → 7.3)
6. レジリエンス機能 (2.3, 5.4 → 5.5)
7. 残りのフェーズ順次実装
